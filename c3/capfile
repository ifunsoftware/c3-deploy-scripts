role :backend, "aphreet@192.168.1.109", "aphreet@192.168.1.112"
set :gateway, "routeradmin@plabrouter.ifunsoftware.com:212"

namespace :c3 do	
	set :virgo_root, "/opt/local/virgo" 
	set :c3_tmp_dir, "/opt/local/tmp"
	set :c3_version, "1.3.6.SNAPSHOT"
	set :c3_web_war, "c3webclient-1.0.0.war"

	task :stop do
  		run "#{virgo_root}/bin/shutdown.sh"
  		#in 5 seconds test if virgo is still alive and if it is - kill it with fire!
  		run "sleep 5 && #{virgo_root}/bin/force_shutdown.sh"
	end

	task :start do
  		run "nohup #{virgo_root}/bin/startup.sh > /dev/null 2>&1 </dev/null &"
	end

	task :cleanup do
		run "rm -rf #{c3_tmp_dir}"
  		run "mkdir -p #{c3_tmp_dir}"
	end

	task :put_platform do
  		run "cd #{c3_tmp_dir} && wget -q http://build.ifunsoftware.com/guestAuth/repository/download/bt4/.lastPinned/c3-all-#{c3_version}.zip"
  		run "cd #{c3_tmp_dir} && unzip *.zip"
	end

	task :deploy_platform do
  		run "rm -f #{virgo_root}/repository/usr/*"
  		run "cp #{c3_tmp_dir}/server/lib/* #{virgo_root}/repository/usr"
  		run "cp #{c3_tmp_dir}/server/pickup/* #{virgo_root}/pickup"
	end

	task :put_web do
  		run "cd #{c3_tmp_dir} && wget -q http://build.ifunsoftware.com/guestAuth/repository/download/bt7/.lastSuccessful/#{c3_web_war}"
	end

	task :deploy_web do
		run "cp #{c3_tmp_dir}/#{c3_web_war} #{virgo_root}/pickup"
	end

	desc "Updates c3 platform and c3 web to the latest versions from build server"
	task :update_all, :roles => :backend do
		stop
		cleanup
		put_platform
		put_web
		deploy_platform
		deploy_web
		start
	end

	desc "Updates c3 platform to the latest version from the build server"
	task :update_platform, :roles => :backend do
		stop
		cleanup
		put_platform
		deploy_platform
		start
	end

	desc "Updates c3 web to the latest version from the build server"
	task :update_web, :roles => :backend do
		stop
		cleanup
		put_web
		deploy_web
		start
	end

	desc "Gathers logs from c3 nodes"
	task :download_logs, :roles => :backend do
		download("#{virgo_root}/serviceability/logs/", "downloads/log-$CAPISTRANO:HOST$", :recursive => true)
	end

	desc "Gathers c3 configuration from nodes"
	task :download_configs, :roles => :backend do
		download("/home/aphreet/.c3/", "downloads/config-$CAPISTRANO:HOST$", :recursive => true)
	end

	task :full_cleanup, :roles => :backend do
		stop
		run "rm -f #{virgo_root}/repository/usr/*"
		run "rm -f #{virgo_root}/pickup/*"
		run "rm -rf #{virgo_root}/work"
		run "rm -rf #{virgo_root}/serviceability"
	end

end
